name: CI/CD to GCP GKE

on:
  push:
    branches: [ temp-ci/cd, main ]
  pull_request:
    branches: [ temp-ci/cd, main ]

env:
  PROJECT_ID: btl-ecommerce-prod
  GKE_CLUSTER: ecommerce-cluster
  GKE_REGION: asia-southeast1
  DOCKER_REPO: asia-southeast1-docker.pkg.dev/btl-ecommerce-prod/ecommerce-repo

jobs:
  # Job 1: Build and Test
  build-test:
    name: Build and Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 8
        uses: actions/setup-java@v4
        with:
          java-version: '8'
          distribution: 'temurin'
          cache: 'maven'

      - name: Cache Maven packages
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      - name: Build with Maven
        run: mvn clean install -DskipTests

      - name: Run Tests
        run: mvn test
        continue-on-error: true

      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: '**/target/surefire-reports/*.xml'
          retention-days: 7

  # Job 2: Build and Push to GCR
  build-push-gcr:
    name: Build and Push to Google Artifact Registry
    runs-on: ubuntu-latest
    needs: build-test
    if: github.event_name == 'push'

    permissions:
      contents: 'read'
      id-token: 'write'

    strategy:
      fail-fast: false
      matrix:
        include:
          - service: config
            path: system/config
            jar: service-config-1.0.jar
          - service: discovery-server
            path: system/discovery-server
            jar: service-discovery-1.0.jar
          - service: gateway
            path: system/gateway
            jar: service-gateway-1.0.jar
          - service: authentication
            path: system/authentication
            jar: service-authentication-1.0.jar
          - service: product
            path: services/product
            jar: product-1.0.jar
          - service: order
            path: services/order
            jar: order-1.0.jar
          - service: monitoring
            path: system/monitoring
            jar: service-monitoring-1.0.jar

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 8
        uses: actions/setup-java@v4
        with:
          java-version: '8'
          distribution: 'temurin'
          cache: 'maven'

      - name: Build specific module
        run: mvn clean package -pl ${{ matrix.path }} -am -DskipTests

      - name: Verify JAR exists
        run: |
          ls -la ${{ matrix.path }}/target/
          if [ ! -f "${{ matrix.path }}/target/${{ matrix.jar }}" ]; then
            echo "âŒ JAR file not found!"
            exit 1
          fi
          echo "âœ… JAR file found: ${{ matrix.jar }}"

      # Authenticate to Google Cloud
      - id: 'auth'
        name: 'Authenticate to Google Cloud'
        uses: 'google-github-actions/auth@v2'
        with:
            credentials_json: '${{ secrets.GCP_SA_KEY }}'  # â† QUAN TRá»ŒNG

      - name: 'Set up Cloud SDK'
        uses: 'google-github-actions/setup-gcloud@v2'

      - name: 'Configure Docker for GCR'
        run: |
          gcloud auth configure-docker ${{ env.GKE_REGION }}-docker.pkg.dev

      - name: Determine image tag
        id: image-tag
        run: |
          SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "tag=prod-${SHORT_SHA}" >> $GITHUB_OUTPUT
            echo "env=production" >> $GITHUB_OUTPUT
            echo "latest_tag=prod-latest" >> $GITHUB_OUTPUT
          else
            echo "tag=staging-${SHORT_SHA}" >> $GITHUB_OUTPUT
            echo "env=staging" >> $GITHUB_OUTPUT
            echo "latest_tag=staging-latest" >> $GITHUB_OUTPUT
          fi

      - name: Build and push ${{ matrix.service }} to GCR
        working-directory: ${{ matrix.path }}
        run: |
          IMAGE_NAME=${{ env.DOCKER_REPO }}/ecommerce-${{ matrix.service }}
          
          echo "ðŸ”¨ Building Docker image for ${{ matrix.service }}..."
          docker build \
            -t ${IMAGE_NAME}:${{ steps.image-tag.outputs.tag }} \
            -t ${IMAGE_NAME}:${{ steps.image-tag.outputs.latest_tag }} \
            .
          
          echo "ðŸ“¤ Pushing images to Google Artifact Registry..."
          docker push ${IMAGE_NAME}:${{ steps.image-tag.outputs.tag }}
          docker push ${IMAGE_NAME}:${{ steps.image-tag.outputs.latest_tag }}
          
          echo "âœ… Successfully pushed ${{ matrix.service }}"

  # Job 3: Update Kubernetes Manifests
  update-manifests:
    name: Update K8s Manifests for ArgoCD
    runs-on: ubuntu-latest
    needs: build-push-gcr
    if: github.event_name == 'push'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Determine environment
        id: env
        run: |
          SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "environment=production" >> $GITHUB_OUTPUT
            echo "tag=prod-${SHORT_SHA}" >> $GITHUB_OUTPUT
          else
            echo "environment=staging" >> $GITHUB_OUTPUT
            echo "tag=staging-${SHORT_SHA}" >> $GITHUB_OUTPUT
          fi

      - name: Install Kustomize
        run: |
          curl -s "https://raw.githubusercontent.com/kubernetes-sigs/kustomize/master/hack/install_kustomize.sh" | bash
          sudo mv kustomize /usr/local/bin/
          kustomize version

      - name: Update image tags in kustomization
        run: |
          cd k8s/overlays/${{ steps.env.outputs.environment }}
          
          DOCKER_REPO=${{ env.DOCKER_REPO }}
          TAG=${{ steps.env.outputs.tag }}
          
          echo "ðŸ“ Updating image tags to ${TAG}..."
          
          kustomize edit set image \
            ${DOCKER_REPO}/ecommerce-config=${DOCKER_REPO}/ecommerce-config:${TAG} \
            ${DOCKER_REPO}/ecommerce-discovery-server=${DOCKER_REPO}/ecommerce-discovery-server:${TAG} \
            ${DOCKER_REPO}/ecommerce-gateway=${DOCKER_REPO}/ecommerce-gateway:${TAG} \
            ${DOCKER_REPO}/ecommerce-authentication=${DOCKER_REPO}/ecommerce-authentication:${TAG} \
            ${DOCKER_REPO}/ecommerce-product=${DOCKER_REPO}/ecommerce-product:${TAG} \
            ${DOCKER_REPO}/ecommerce-order=${DOCKER_REPO}/ecommerce-order:${TAG} \
            ${DOCKER_REPO}/ecommerce-monitoring=${DOCKER_REPO}/ecommerce-monitoring:${TAG}}
          
          echo "âœ… Updated kustomization.yaml"
          cat kustomization.yaml

      - name: Commit and push changes
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          
          git add k8s/overlays/${{ steps.env.outputs.environment }}/kustomization.yaml
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "ðŸš€ Update ${{ steps.env.outputs.environment }} image tags to ${{ steps.env.outputs.tag }}"
            git push
            echo "âœ… Changes pushed to repository"
          fi

  # Job 4: Deploy to GKE (Optional - náº¿u khÃ´ng dÃ¹ng ArgoCD)
  deploy-gke:
    name: Deploy to GKE
    runs-on: ubuntu-latest
    needs: update-manifests
    if: github.event_name == 'push' && vars.ENABLE_DIRECT_DEPLOY == 'true'

    permissions:
      contents: 'read'
      id-token: 'write'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - id: 'auth'
        name: 'Authenticate to Google Cloud'
        uses: 'google-github-actions/auth@v2'
        with:
          credentials_json: '${{ secrets.GCP_SA_KEY }}'

      - name: 'Set up Cloud SDK'
        uses: 'google-github-actions/setup-gcloud@v2'

      - name: 'Get GKE credentials'
        run: |
          gcloud container clusters get-credentials ${{ env.GKE_CLUSTER }} \
            --region=${{ env.GKE_REGION }}

      - name: Determine environment
        id: env
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "environment=production" >> $GITHUB_OUTPUT
            echo "namespace=ecommerce-production" >> $GITHUB_OUTPUT
          else
            echo "environment=staging" >> $GITHUB_OUTPUT
            echo "namespace=ecommerce-staging" >> $GITHUB_OUTPUT
          fi

      - name: Install Kustomize
        run: |
          curl -s "https://raw.githubusercontent.com/kubernetes-sigs/kustomize/master/hack/install_kustomize.sh" | bash
          sudo mv kustomize /usr/local/bin/

      - name: Deploy to GKE
        run: |
          cd k8s/overlays/${{ steps.env.outputs.environment }}
          kustomize build . | kubectl apply -f -
          
          echo "âœ… Deployed to ${{ steps.env.outputs.environment }}"

      - name: Verify deployment
        run: |
          kubectl rollout status deployment/gateway -n ${{ steps.env.outputs.namespace }}
          kubectl rollout status deployment/product-service -n ${{ steps.env.outputs.namespace }}
          kubectl rollout status deployment/order-service -n ${{ steps.env.outputs.namespace }}
          
          echo "âœ… All deployments are ready"

      - name: Get service URL
        run: |
          kubectl get svc gateway -n ${{ steps.env.outputs.namespace }}